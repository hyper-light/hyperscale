---
ad_number: 26
name: Adaptive Healthcheck Extensions
description: Allows healthcheck deadline extensions with logarithmic grant reduction for long operations
---

# AD-26: Adaptive Healthcheck Extensions

**Decision**: Allow healthcheck deadline extensions with logarithmic grant reduction.

**Rationale**:
- Long-running operations may legitimately need more time
- Unlimited extensions enable abuse
- Logarithmic reduction discourages repeated requests
- Extensions require active negotiation (not automatic)

**Extension Protocol**:
```
┌─────────────────────────────────────────────────────────────────┐
│              Adaptive Healthcheck Extensions                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Base deadline: 30 seconds                                      │
│                                                                 │
│  Extension grants (logarithmic reduction):                      │
│  ├─ 1st extension: +30s (100% of base)                         │
│  ├─ 2nd extension: +15s (50% of base)                          │
│  ├─ 3rd extension: +7.5s (25% of base)                         │
│  ├─ 4th extension: +3.75s (12.5% of base)                      │
│  └─ ...converges to minimum (1s)                               │
│                                                                 │
│  Formula: grant = max(min_grant, base / (2^extension_count))   │
│                                                                 │
│  Extension request must include:                                │
│  ├─ reason: "long_workflow" | "gc_pause" | "resource_contention"│
│  ├─ estimated_completion: timestamp                            │
│  └─ current_progress: 0.0-1.0                                  │
│                                                                 │
│  Extension denied if:                                           │
│  ├─ No progress since last extension                           │
│  ├─ Total extensions exceed max (e.g., 5)                      │
│  └─ Node is already marked suspect                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation**:
```python
@dataclass
class ExtensionTracker:
    """Tracks healthcheck extensions for a worker."""
    worker_id: str
    base_deadline: float = 30.0
    min_grant: float = 1.0
    max_extensions: int = 5

    extension_count: int = 0
    last_progress: float = 0.0
    total_extended: float = 0.0

    def request_extension(
        self,
        reason: str,
        current_progress: float,
    ) -> tuple[bool, float]:
        """
        Request deadline extension.
        Returns (granted, extension_seconds).
        """
        # Deny if too many extensions
        if self.extension_count >= self.max_extensions:
            return False, 0.0

        # Deny if no progress
        if current_progress <= self.last_progress and self.extension_count > 0:
            return False, 0.0

        # Calculate grant with logarithmic reduction
        grant = max(
            self.min_grant,
            self.base_deadline / (2 ** self.extension_count)
        )

        self.extension_count += 1
        self.last_progress = current_progress
        self.total_extended += grant

        return True, grant

    def reset(self) -> None:
        """Reset tracker when worker completes operation or recovers."""
        self.extension_count = 0
        self.last_progress = 0.0
        self.total_extended = 0.0
```

**Message Types**:
```python
@dataclass
class HealthcheckExtensionRequest:
    """Worker requests more time before being marked unhealthy."""
    worker_id: str
    reason: str  # "long_workflow" | "gc_pause" | "resource_contention"
    current_progress: float  # 0.0 to 1.0
    estimated_completion: float  # Unix timestamp
    active_workflow_count: int

@dataclass
class HealthcheckExtensionResponse:
    """Manager response to extension request."""
    granted: bool
    extension_seconds: float  # 0.0 if not granted
    new_deadline: float  # Unix timestamp of new deadline
    remaining_extensions: int  # How many more can be requested
    denial_reason: str | None = None  # If not granted
```

**Complete Protocol Flow Example**:
```
┌─────────────────────────────────────────────────────────────────┐
│           Healthcheck Extension Protocol Flow                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Worker                                    Manager              │
│    │                                          │                 │
│    │◄──── Healthcheck probe ─────────────────│ (deadline: 30s) │
│    │                                          │                 │
│    │  [Running long workflow, needs more time]│                 │
│    │                                          │                 │
│    │─── ExtensionRequest(progress=0.3) ─────►│                 │
│    │                                          │                 │
│    │    [Manager: extension_count=0]          │                 │
│    │    [Grant: 30s / 2^0 = 30s]              │                 │
│    │                                          │                 │
│    │◄── ExtensionResponse(granted=True, 30s)─│ (deadline: 60s) │
│    │                                          │                 │
│    │  [Still working...]                      │                 │
│    │                                          │                 │
│    │─── ExtensionRequest(progress=0.6) ─────►│                 │
│    │                                          │                 │
│    │    [Manager: extension_count=1]          │                 │
│    │    [Grant: 30s / 2^1 = 15s]              │                 │
│    │                                          │                 │
│    │◄── ExtensionResponse(granted=True, 15s)─│ (deadline: 75s) │
│    │                                          │                 │
│    │─── ExtensionRequest(progress=0.6) ─────►│ [NO PROGRESS!]  │
│    │                                          │                 │
│    │◄── ExtensionResponse(granted=False) ────│ (denied)        │
│    │                                          │                 │
│    │  [Worker marked SUSPECT after deadline] │                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Manager-Side Integration**:
```python
class WorkerHealthManager:
    """Manages worker health with extension support."""

    def __init__(self):
        self._extension_trackers: dict[str, ExtensionTracker] = {}
        self._worker_deadlines: dict[str, float] = {}

    def handle_extension_request(
        self,
        request: HealthcheckExtensionRequest,
    ) -> HealthcheckExtensionResponse:
        """Process extension request from worker."""
        tracker = self._extension_trackers.setdefault(
            request.worker_id,
            ExtensionTracker(worker_id=request.worker_id)
        )

        granted, extension_seconds = tracker.request_extension(
            reason=request.reason,
            current_progress=request.current_progress,
        )

        if granted:
            current_deadline = self._worker_deadlines.get(
                request.worker_id,
                time.monotonic() + 30.0
            )
            new_deadline = current_deadline + extension_seconds
            self._worker_deadlines[request.worker_id] = new_deadline

            return HealthcheckExtensionResponse(
                granted=True,
                extension_seconds=extension_seconds,
                new_deadline=new_deadline,
                remaining_extensions=tracker.max_extensions - tracker.extension_count,
            )
        else:
            denial_reason = self._get_denial_reason(tracker, request)
            return HealthcheckExtensionResponse(
                granted=False,
                extension_seconds=0.0,
                new_deadline=self._worker_deadlines.get(request.worker_id, 0.0),
                remaining_extensions=max(0, tracker.max_extensions - tracker.extension_count),
                denial_reason=denial_reason,
            )

    def _get_denial_reason(
        self,
        tracker: ExtensionTracker,
        request: HealthcheckExtensionRequest,
    ) -> str:
        if tracker.extension_count >= tracker.max_extensions:
            return f"Maximum extensions ({tracker.max_extensions}) exceeded"
        if request.current_progress <= tracker.last_progress:
            return f"No progress since last extension (was {tracker.last_progress}, now {request.current_progress})"
        return "Extension denied"

    def on_worker_healthy(self, worker_id: str) -> None:
        """Reset extension tracker when worker completes successfully."""
        if worker_id in self._extension_trackers:
            self._extension_trackers[worker_id].reset()
```

**Grant Reduction Table**:
| Extension # | Formula | Grant (base=30s) | Cumulative |
|-------------|---------|------------------|------------|
| 1 | 30 / 2^0 | 30.0s | 30.0s |
| 2 | 30 / 2^1 | 15.0s | 45.0s |
| 3 | 30 / 2^2 | 7.5s | 52.5s |
| 4 | 30 / 2^3 | 3.75s | 56.25s |
| 5 | 30 / 2^4 | 1.875s -> 1.0s (min) | 57.25s |
| 6+ | - | denied | - |

**Key Properties**:
- **Converging**: Total extension converges (geometric series)
- **Progress-gated**: Must show forward progress to get more time
- **Bounded**: Hard limit on extension count prevents indefinite delays
- **Self-limiting**: Diminishing returns discourage dependency on extensions
