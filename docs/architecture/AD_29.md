---
ad_number: 29
name: Protocol-Level Peer Confirmation for Robust Initialization
description: Confirmed vs unconfirmed peer model preventing false positives during cluster formation
---

# AD-29: Protocol-Level Peer Confirmation for Robust Initialization

**Decision**: Implement a "confirmed vs unconfirmed peer" model where failure detection only applies to peers we have successfully communicated with at least once. Peers from configuration start as "unconfirmed" and must receive a successful probe response, heartbeat, or other protocol message before they can transition to the failure detection state machine.

**Rationale**:
During cluster formation, nodes begin probing each other immediately. Due to network timing, async startup order, and other transient conditions, initial probes may fail even though all nodes are healthy. Without distinguishing "never reached" from "was reachable, now isn't", the SWIM failure detector triggers false positives, causing cascading "failures" that destabilize the cluster before it ever forms.

**Problem Statement**:
```
Timeline without peer confirmation:

T=0: Gate1, Gate2, Gate3 start simultaneously
T=0.1: Gate1 sends probe to Gate2 (Gate2 not yet listening)
T=1.1: Gate1 probe times out -> Gate1 marks Gate2 as SUSPECT
T=2.5: Gate1 indirect probes fail -> Gate1 marks Gate2 as DEAD
T=3.0: Gate2 finally ready, sends heartbeat to Gate1
T=3.1: Gate1 receives heartbeat but already removed Gate2 from active peers

Result: Cluster never stabilizes, continuous false failure detection
```

## Solution: Confirmed vs Unconfirmed Peers

```
+---------------------------------------------------------------------------------+
|                     PEER STATE MACHINE                                          |
+---------------------------------------------------------------------------------+
|                                                                                 |
|    +--------------------+                                                       |
|    |                    |                                                       |
|    |   UNCONFIRMED      |  --- Peers from config, not yet reached               |
|    |                    |                                                       |
|    |  * No failure      |                                                       |
|    |    detection       |                                                       |
|    |  * Probe attempts  |                                                       |
|    |    continue        |                                                       |
|    |  * Not in active   |                                                       |
|    |    peer set        |                                                       |
|    |                    |                                                       |
|    +---------+----------+                                                       |
|              |                                                                  |
|              | Successful communication:                                        |
|              | * Probe ACK received                                             |
|              | * Heartbeat received                                             |
|              | * Any valid protocol message                                     |
|              |                                                                  |
|              v                                                                  |
|    +--------------------+                                                       |
|    |                    |                                                       |
|    |    CONFIRMED       |  --- Successfully communicated at least once          |
|    |                    |                                                       |
|    |  * Normal SWIM     |      +------------------------------------------+     |
|    |    failure         |      |                                          |     |
|    |    detection       |      |  SWIM State Machine (per Lifeguard)      |     |
|    |  * Added to        |      |                                          |     |
|    |    active peers    |      |  ALIVE --timeout--> SUSPECT              |     |
|    |  * Participates    |      |    ^                   |                 |     |
|    |    in gossip       |      |    |                   | no refutation   |     |
|    |                    |      |    | refutation        v                 |     |
|    |                    |      |    +----------------- DEAD               |     |
|    |                    |      |                                          |     |
|    +--------------------+      +------------------------------------------+     |
|                                                                                 |
+---------------------------------------------------------------------------------+
```

## Implementation Details

**1. Data Structures**:
```python
class HealthAwareServer:
    # Peers we've successfully communicated with at least once
    _confirmed_peers: set[tuple[str, int]]

    # Peers we know about but haven't confirmed yet (from config)
    _unconfirmed_peers: set[tuple[str, int]]
```

**2. Peer Addition** (from config or discovery):
```python
async def _add_peer(self, peer: tuple[str, int]):
    """Peer from configuration starts as unconfirmed."""
    if peer not in self._confirmed_peers:
        self._unconfirmed_peers.add(peer)
    # Begin probing to confirm
```

**3. Peer Confirmation** (on ANY successful communication):
```python
async def _confirm_peer(self, peer: tuple[str, int]):
    """Mark peer as confirmed after successful communication."""
    if peer in self._unconfirmed_peers:
        self._unconfirmed_peers.discard(peer)
        self._confirmed_peers.add(peer)
        # NOW add to active peer tracking (e.g., _active_gate_peers)
        await self._on_peer_confirmed(peer)
```

**4. Failure Detection Guard**:
```python
async def _on_probe_timeout(self, peer: tuple[str, int]):
    if peer not in self._confirmed_peers:
        # Never reached this peer - log but don't escalate
        # Continue probing, eventually we'll reach them
        return

    # Confirmed peer didn't respond - THIS is meaningful
    await self._start_suspicion(peer)
```

**5. Recovery Re-confirmation**:
```python
async def _on_node_join(self, peer: tuple[str, int]):
    """Node rejoined - it's already confirmed from before."""
    # No need to re-confirm, just update state
    if peer in self._confirmed_peers:
        await self._handle_peer_recovery(peer)
```

## Events That Confirm a Peer

- Receiving an ACK to our probe
- Receiving a heartbeat message
- Receiving any valid protocol message (join, leave, alive, etc.)
- Receiving a response to indirect probe request

## Events That Do NOT Confirm

- Adding peer from configuration
- Receiving gossip ABOUT a peer from another node
- DNS resolution returning the peer's address

## Strict Lifeguard Compliance

This approach works IN CONJUNCTION with proper Lifeguard suspicion protocol:

1. Probe timeout -> SUSPECT (never directly to DEAD)
2. SUSPECT -> Broadcast suspicion, request indirect probes
3. SUSPECT + timeout without refutation -> DEAD
4. Refutation received -> Back to ALIVE

The key insight: **Suspicion only applies to CONFIRMED peers**. An unconfirmed peer cannot be "suspected" because we have no baseline expectation of their reachability.

## Sequence Diagram - Correct Initialization

```
Gate1                    Gate2                    Gate3
  |                        |                        |
  | T=0: Start             | T=0: Start             | T=0: Start
  |                        |                        |
  |---- probe ------------>| (not ready yet)        |
  |     TIMEOUT            |                        |
  |     [unconfirmed, no   |                        |
  |      failure action]   |                        |
  |                        |                        |
  |                        |---- heartbeat -------->|
  |                        |                        |
  |<------- heartbeat -----|                        |
  |  [Gate2 CONFIRMED!]    |                        |
  |  [add to active peers] |                        |
  |                        |                        |
  |---- probe ------------>|                        |
  |<------ ACK ------------|                        |
  |  [confirmed, ACK       |                        |
  |   reinforces health]   |                        |
  |                        |                        |
  |<-------------------------- heartbeat -----------|
  |  [Gate3 CONFIRMED!]    |                        |
  |                        |                        |
  v                        v                        v
All peers confirmed, cluster stable
```

## Sequence Diagram - Failure After Confirmation

```
Gate1                    Gate2 (crashes)           Gate3
  |                        |                        |
  | [Gate2 confirmed]      |                        |
  |                        X crash                  |
  |                        |                        |
  |---- probe ------------>|                        |
  |     TIMEOUT            |                        |
  |  [CONFIRMED peer       |                        |
  |   failed - start       |                        |
  |   SUSPICION]           |                        |
  |                        |                        |
  |---- ping-req ---------------------------------------->|
  |  [indirect probe       |                        |---- probe -->| (dead)
  |   via Gate3]           |                        |   TIMEOUT    |
  |<------- NACK ----------------------------------------|
  |                        |                        |
  |  [no refutation after  |                        |
  |   suspicion timeout]   |                        |
  |                        |                        |
  |  Gate2 -> DEAD         |                        |
  |  [remove from active]  |                        |
```

**Trade-offs**:
- (+) No arbitrary timeouts - behavior based on actual protocol state
- (+) Correct Lifeguard semantics - suspicion is meaningful
- (+) Self-healing - if peer comes up later, we'll reach them and confirm
- (+) No false positives during initialization
- (+) Memory efficient - just two sets, not per-peer epoch tracking
- (+) Works with any cluster size or topology
- (-) Initial probe failures are "silent" - may delay detection of config errors
- (-) Requires discipline to call _confirm_peer on all successful paths

## Mitigation for Silent Failures

Add logging/metrics for unconfirmed peers that remain unconfirmed after a threshold:
```python
if peer_unconfirmed_duration > 60.0:  # 1 minute
    log.warning(f"Peer {peer} still unconfirmed after 60s - check configuration")
```

## Files to Modify

- `hyperscale/distributed_rewrite/swim/health_aware_server.py` - Base SWIM implementation
- `hyperscale/distributed_rewrite/nodes/gate.py` - Gate peer tracking
- `hyperscale/distributed_rewrite/nodes/manager.py` - Manager peer tracking
- `hyperscale/distributed_rewrite/nodes/worker.py` - Worker manager tracking

**Alternatives Considered**:
1. **Grace Period**: Arbitrary timeout, masks real failures during startup
2. **Quorum-Based Init**: Deadlock potential if all nodes wait for quorum
3. **Two-Phase Bootstrap**: Good but doesn't handle dynamic peer discovery
4. **Epoch-Based Freshness**: More complex, higher memory overhead

**Testing Strategy**:
1. Unit tests for confirmed/unconfirmed state transitions
2. Integration test: 3+ gates starting simultaneously, verify no false failures
3. Integration test: Confirmed peer crash, verify proper SUSPECT->DEAD flow
4. Integration test: Unconfirmed peer never reachable, verify no DEAD transition
