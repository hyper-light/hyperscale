---
ad_number: 44
name: Retry Budgets and Best-Effort Completion
description: Job-level retry limits with per-workflow caps and partial completion support for DC failures.
---

# AD-44: Retry Budgets and Best-Effort Completion

## Part 1: Problem Statement

**Current Limitations**:

1. **Retry Storms**: Each workflow retries independently up to `max_dispatch_attempts` (default 5). A job with 100 workflows can generate 500 retries, overwhelming the cluster during failures.

2. **No Partial Completion Control**: When a datacenter is lost, jobs wait indefinitely for results that will never arrive. Tests cannot explicitly opt into "best-effort" semantics where partial results are acceptable.

3. **No Job-Level Retry Control**: Jobs cannot specify their retry tolerance. A critical job and a best-effort job both get the same retry behavior.

---

## Part 2: Design Overview

**Two complementary features**:

### Retry Budgets
- Job-level retry limit shared across all workflows
- Per-workflow caps prevent single workflow from consuming entire budget
- Env-enforced hard ceilings

### Best-Effort Mode
- Explicit partial completion when minimum DC threshold is met
- Configurable deadline for completion
- Returns available results rather than waiting indefinitely

---

## Part 3: Retry Budget Architecture

### Budget Model

```python
@dataclass(slots=True)
class RetryBudgetState:
    job_id: str
    total_budget: int               # Effective budget (clamped to max)
    per_workflow_max: int           # Per-workflow limit (clamped)
    consumed: int = 0               # Total retries consumed
    per_workflow_consumed: dict[str, int] = field(default_factory=dict)

    def can_retry(self, workflow_id: str) -> tuple[bool, str]:
        """Check if workflow can retry. Returns (allowed, reason)."""

    def consume_retry(self, workflow_id: str) -> None:
        """Record a retry attempt."""
```

### Enforcement Flow

1. **Job Submission**: Manager clamps budget to Env limits
2. **Dispatch Failure**: Check budget before applying backoff
3. **Budget Allowed**: Consume retry, apply backoff, schedule retry
4. **Budget Exhausted**: Mark workflow as permanently failed

### Integration with Existing Retry Logic

Budget check happens in `WorkflowDispatcher._dispatch_workflow()` before applying backoff. If budget exhausted, workflow marked as failed without retry.

---

## Part 4: Best-Effort Mode Architecture

### State Model

```python
@dataclass(slots=True)
class BestEffortState:
    job_id: str
    enabled: bool
    min_dcs: int                    # Minimum DCs for success
    deadline: float                 # Absolute monotonic time
    target_dcs: set[str]            # All target DCs
    dcs_completed: set[str] = field(default_factory=set)
    dcs_failed: set[str] = field(default_factory=set)

    def check_completion(self, now: float) -> tuple[bool, str, bool]:
        """Check if job should complete. Returns (should_complete, reason, is_success)."""
```

### Completion Triggers

1. **All DCs reported**: Normal completion
2. **min_dcs reached**: Complete with partial results (success)
3. **Deadline expired**: Complete with available results

### Late DC Results

When a DC reports after job completion:
- Result logged but not aggregated (default)
- OR: Job result updated with late DC data (configurable)

---

## Part 5: Extended JobSubmission Model

```python
@dataclass(slots=True)
class JobSubmission(Message):
    # ... existing fields ...

    # AD-44: Retry Budget
    retry_budget: int = 0                       # 0 = use default
    retry_budget_per_workflow: int = 0          # 0 = use default

    # AD-44: Best-Effort Mode
    best_effort: bool = False
    best_effort_min_dcs: int = 1                # Minimum DCs for success
    best_effort_deadline_seconds: float = 300.0 # Max wait time
```

---

## Part 6: Environment Configuration

```python
# Retry Budget Settings (AD-44)
RETRY_BUDGET_DEFAULT: int = 20
RETRY_BUDGET_MAX: int = 50
RETRY_BUDGET_PER_WORKFLOW_DEFAULT: int = 3
RETRY_BUDGET_PER_WORKFLOW_MAX: int = 5

# Best-Effort Settings (AD-44)
BEST_EFFORT_DEFAULT_MIN_DCS: int = 1
BEST_EFFORT_DEFAULT_DEADLINE_SECONDS: float = 300.0
BEST_EFFORT_LATE_RESULT_POLICY: str = "log_only"  # or "update_result"
BEST_EFFORT_CHECK_INTERVAL_SECONDS: float = 5.0
```

---

## Part 7: Observability

### Metrics

- `retry_budget_consumed_total{job_id}`
- `retry_budget_exhausted_total{job_id}`
- `best_effort_completions_total{reason}`
- `best_effort_completion_ratio{job_id}`

### Logs

- `RetryBudgetExhausted`: When job or workflow budget depleted
- `BestEffortCompletion`: When job completes via best-effort path
- `LateDatacenterResult`: When DC reports after job completion
