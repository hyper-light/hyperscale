---
ad_number: 33
name: Federated Health Monitoring for Cross-DC Coordination
description: Separate health monitoring layer for gates to monitor remote DC manager clusters
---

# AD-33: Federated Health Monitoring for Cross-DC Coordination

**Problem**: Gates need to monitor health of remote datacenter manager clusters to make routing decisions. The existing SWIM protocol is designed for intra-cluster membership with low-latency assumptions (1-10ms RTT), but cross-DC links have high latency (50-300ms RTT) and don't need full membership semantics.

**Solution**: FederatedHealthMonitor - a separate health monitoring layer that uses SWIM-style probe/ack but without gossip or membership.

---

## Part 1: Architecture Overview

```
+-------------------------------------------------------------------+
|                         GATE CLUSTER                               |
|  +---------+    +---------+    +---------+                        |
|  |  Gate   |<-->|  Gate   |<-->|  Gate   |  <- SWIM membership    |
|  |(leader) |    |         |    |         |    between gates       |
|  +----+----+    +---------+    +---------+                        |
|       |                                                            |
|       | FederatedHealthMonitor                                     |
|       | (xprobe/xack)                                              |
|       v                                                            |
+-------------------------------------------------------------------+
|       |              |              |                              |
|  +----+----+    +----+----+    +----+----+                        |
|  | DC-East |    | DC-West |    |DC-Europe|   <- Remote DCs        |
|  | Leader  |    | Leader  |    | Leader  |                        |
|  +---------+    +---------+    +---------+                        |
|       ^              ^              ^                              |
|       |              |              |                              |
|     SWIM           SWIM           SWIM       <- Each DC has its   |
|   (managers)     (managers)     (managers)    own SWIM cluster    |
+-------------------------------------------------------------------+
```

**Key Distinction**: FederatedHealthMonitor is NOT cluster membership - it's health monitoring using probe/ack.

---

## Part 2: Comparison with SWIM

| Aspect | SWIM (Intra-cluster) | FederatedHealthMonitor (Cross-cluster) |
|--------|---------------------|---------------------------------------|
| **Scope** | Nodes within single DC cluster | Gates -> DC leader managers across DCs |
| **Protocol** | Full SWIM (ping, ping-req, suspect, dead) | Simple probe/ack only (`xprobe`/`xack`) |
| **Gossip** | Yes - membership and state propagation | No - just health checking |
| **Latency tolerance** | Low (local network, 1-10ms) | High (global network, 50-300ms) |
| **Suspicion timeout** | Short (1.5-8 seconds) | Long (30 seconds default) |
| **Purpose** | Cluster membership and failure detection | Cross-DC routing decisions |
| **Incarnation** | Shared cluster incarnation | Separate external incarnation per DC |

---

## Part 3: Protocol Messages

**CrossClusterProbe (xprobe)**: Sent from gates to DC leader managers.

```python
@dataclass(slots=True)
class CrossClusterProbe(Message):
    source_cluster_id: str  # Gate cluster ID
    source_node_id: str     # Sending gate's node ID
    source_addr: tuple[str, int]  # For response routing
```

**CrossClusterAck (xack)**: Response from DC leader with aggregate health.

```python
@dataclass(slots=True)
class CrossClusterAck(Message):
    # Identity
    datacenter: str
    node_id: str
    incarnation: int  # External incarnation (separate from SWIM)

    # Leadership
    is_leader: bool
    leader_term: int

    # Cluster health (aggregate)
    cluster_size: int       # Total managers in DC
    healthy_managers: int   # Managers responding to SWIM

    # Worker capacity
    worker_count: int
    healthy_workers: int
    total_cores: int
    available_cores: int

    # Workload
    active_jobs: int
    active_workflows: int

    # Self-reported health
    dc_health: str  # "HEALTHY", "DEGRADED", "BUSY", "UNHEALTHY"
    health_reason: str = ""
```

---

## Part 4: State Machine

**DCReachability States**:

```
                    +-------------+
                    | UNREACHABLE | <-- Initial state
                    +------+------+
                           | First successful ack
                           v
                    +-------------+
         +--------->|  REACHABLE  |<--------------+
         |          +------+------+               |
         |                 | consecutive_failures |
         |                 | >= max_failures      |
         |                 v                      |
         |          +-------------+               |
         |          |  SUSPECTED  |---------------+
         |          +------+------+  ack received
         |                 | suspicion_timeout
         |                 | expired
         |                 v
         |          +-------------+
         +----------| UNREACHABLE |
    leader change   +-------------+
```

---

## Part 5: Configuration

### Environment Variables (env.py)

```python
# Federated Health Monitor Settings (Gate -> DC Leader probing)
# Tuned for high-latency, globally distributed links
FEDERATED_PROBE_INTERVAL: StrictFloat = 2.0      # Seconds between probes to each DC
FEDERATED_PROBE_TIMEOUT: StrictFloat = 5.0       # Timeout for single probe (high for cross-DC)
FEDERATED_SUSPICION_TIMEOUT: StrictFloat = 30.0  # Time before suspected -> unreachable
FEDERATED_MAX_CONSECUTIVE_FAILURES: StrictInt = 5  # Failures before marking suspected
```

### Timing Rationale

| Setting | Value | Rationale |
|---------|-------|-----------|
| `FEDERATED_PROBE_INTERVAL` | 2s | Reduce cross-DC traffic while maintaining freshness |
| `FEDERATED_PROBE_TIMEOUT` | 5s | Accommodate 100-300ms RTT + processing time |
| `FEDERATED_SUSPICION_TIMEOUT` | 30s | Tolerate transient network issues |
| `FEDERATED_MAX_CONSECUTIVE_FAILURES` | 5 | ~10 seconds of failures before suspected |

---

## Part 6: Integration with Cross-DC Correlation

FederatedHealthMonitor feeds into the Cross-DC Correlation system (Phase 7) to prevent cascade evictions:

```python
# Latency callback for correlation detection
def _on_dc_latency(self, datacenter: str, latency_ms: float) -> None:
    """Called with RTT for each successful probe."""
    # Used by CrossDCCorrelationDetector to identify network issues
    # High latency across multiple DCs suggests network problem, not DC failure
    self._correlation_detector.record_latency(datacenter, latency_ms)

# Health change callback
def _on_dc_health_change(self, datacenter: str, new_health: str) -> None:
    """Called when DC reachability or health changes."""
    if new_health in ("SUSPECTED", "UNREACHABLE"):
        # Check if multiple DCs failing simultaneously = network partition
        correlation = self._correlation_detector.check_correlation()
        if correlation.level >= CorrelationLevel.MEDIUM:
            # Delay eviction - likely network issue, not actual DC failures
            pass
```

---

## Part 7: Usage in Gate

```python
class Gate:
    def __init__(self, ...):
        # SWIM for gate-to-gate membership
        self._swim_server = HealthAwareServer(...)

        # FederatedHealthMonitor for cross-DC health
        fed_config = env.get_federated_health_config()
        self._dc_health_monitor = FederatedHealthMonitor(
            probe_interval=fed_config['probe_interval'],
            probe_timeout=fed_config['probe_timeout'],
            suspicion_timeout=fed_config['suspicion_timeout'],
            max_consecutive_failures=fed_config['max_consecutive_failures'],
        )

    async def _route_job(self, job: Job) -> str:
        """Route job to best DC."""
        healthy_dcs = self._dc_health_monitor.get_healthy_datacenters()
        if not healthy_dcs:
            raise NoHealthyDatacentersError()

        # Select based on capacity from xack
        return self._select_best_dc(healthy_dcs)
```

---

## Part 8: Key Design Decisions

1. **No Gossip**: Cross-DC gossip would add latency and complexity. DC leaders already have aggregate health from their local SWIM cluster.

2. **Separate Incarnation**: Each DC tracks its own external incarnation, independent of internal SWIM incarnations. This prevents cross-cluster incarnation conflicts.

3. **Aggregate Health**: DC leaders report aggregate cluster health (healthy managers, available cores) rather than individual node states. This reduces message size and provides the information gates actually need.

4. **Leader-Only Probing**: Gates probe DC leaders, not all managers. Leaders have authoritative cluster state and can respond with aggregate health.

5. **High Latency Tolerance**: Default timeouts (5s probe, 30s suspicion) are 5-10x higher than SWIM defaults, appropriate for global networks.

---

## Part 9: Files

| File | Purpose |
|------|---------|
| `swim/health/federated_health_monitor.py` | FederatedHealthMonitor, CrossClusterProbe, CrossClusterAck |
| `nodes/gate.py` | Integration with gate routing |
| `env/env.py` | Configuration settings |
| `datacenters/cross_dc_correlation.py` | Integration with correlation detection |
