---
ad_number: 23
name: Backpressure for Stats Updates
description: Tiered stats retention with explicit backpressure signaling to prevent memory exhaustion
---

# AD-23: Backpressure for Stats Updates

**Decision**: Implement tiered stats retention with backpressure signaling.

**Rationale**:
- Unbounded stats history causes memory exhaustion
- Different retention needs for different data freshness
- Upstream should slow down when downstream is overwhelmed
- Explicit backpressure prevents silent data loss

**Tiered Retention**:
```
┌─────────────────────────────────────────────────────────────────┐
│                  Tiered Stats Retention                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  HOT (0-60 seconds):                                           │
│  ├─ Full resolution (every update)                             │
│  ├─ In-memory ring buffer                                      │
│  └─ Used for real-time dashboards                              │
│                                                                 │
│  WARM (1-60 minutes):                                          │
│  ├─ 10-second aggregates                                       │
│  ├─ Compressed in-memory                                       │
│  └─ Used for recent history                                    │
│                                                                 │
│  COLD (1-24 hours):                                            │
│  ├─ 1-minute aggregates                                        │
│  ├─ Spill to disk if needed                                    │
│  └─ Used for job post-mortems                                  │
│                                                                 │
│  ARCHIVE (> 24 hours):                                         │
│  ├─ Final summary only                                         │
│  └─ Persisted with job completion                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Backpressure Levels**:
```python
class BackpressureLevel(Enum):
    NONE = 0       # Accept all updates
    THROTTLE = 1   # Reduce update frequency
    BATCH = 2      # Only accept batched updates
    REJECT = 3     # Reject non-critical updates

@dataclass
class StatsBuffer:
    """Bounded stats buffer with backpressure."""
    max_hot_entries: int = 1000
    max_warm_entries: int = 360  # 1 hour at 10s intervals
    max_cold_entries: int = 1440  # 24 hours at 1m intervals

    hot: deque[StatsEntry]
    warm: deque[AggregatedStats]
    cold: deque[AggregatedStats]

    def get_backpressure_level(self) -> BackpressureLevel:
        """Determine backpressure based on buffer fill."""
        hot_fill = len(self.hot) / self.max_hot_entries

        if hot_fill < 0.7:
            return BackpressureLevel.NONE
        elif hot_fill < 0.85:
            return BackpressureLevel.THROTTLE
        elif hot_fill < 0.95:
            return BackpressureLevel.BATCH
        else:
            return BackpressureLevel.REJECT
```
