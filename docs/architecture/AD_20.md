---
ad_number: 20
name: Cancellation Propagation
description: Implements four-phase cancellation flow from Client to Gate to Manager to Worker
---

# AD-20: Cancellation Propagation

**Decision**: Implement four-phase cancellation: Client -> Gate -> Manager -> Worker.

**Rationale**:
- Users need ability to stop long-running jobs
- Resources should be freed promptly
- Cancellation must be idempotent and handle partial failures
- Each layer confirms cancellation before propagating

**Cancellation Flow**:
```
┌─────────────────────────────────────────────────────────────────┐
│                    Cancellation Propagation                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Client                Gate                Manager      Worker  │
│    │                    │                    │            │     │
│    │─ CancelJob(id) ───►│                    │            │     │
│    │                    │─ CancelJob(id) ───►│            │     │
│    │                    │                    │─ Cancel ──►│     │
│    │                    │                    │◄── Ack ────│     │
│    │                    │◄─── Ack ───────────│            │     │
│    │◄─── Ack ───────────│                    │            │     │
│    │                    │                    │            │     │
│  Phase 1: Request    Phase 2: Forward     Phase 3: Execute     │
│                      Phase 4: Confirm (reverse direction)       │
│                                                                 │
│  Timeout behavior:                                              │
│  - If Worker doesn't ACK: Manager retries, then marks failed   │
│  - If Manager doesn't ACK: Gate retries, then best-effort      │
│  - Client receives "cancellation requested" immediately        │
│  - Final status pushed when all DCs confirm                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Message Types**:
```python
@dataclass
class JobCancelRequest:
    job_id: str
    requester_id: str  # For audit trail
    timestamp: float
    fence_token: int  # Must match current job epoch

@dataclass
class JobCancelResponse:
    job_id: str
    success: bool
    cancelled_workflow_count: int
    error: str | None = None
```

**Idempotency**: Cancellation requests are idempotent - repeated requests return success if job is already cancelled or cancelling.
