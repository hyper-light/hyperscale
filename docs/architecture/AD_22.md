---
ad_number: 22
name: Load Shedding with Priority Queues
description: Priority-based request classification to shed low-priority work under overload
---

# AD-22: Load Shedding with Priority Queues

**Decision**: Implement load shedding using priority-based request classification.

**Rationale**:
- Under overload, processing all requests degrades all users
- Shedding low-priority work protects critical operations
- Priority should be explicit, not implicit
- Graceful degradation is better than complete failure

**Priority Levels**:
```
┌─────────────────────────────────────────────────────────────────┐
│                    Load Shedding Priority                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Priority 0 (CRITICAL) - Never shed:                           │
│  ├─ Health checks / liveness probes                            │
│  ├─ Cancellation requests                                      │
│  ├─ Final result delivery                                      │
│  └─ Cluster membership (SWIM)                                  │
│                                                                 │
│  Priority 1 (HIGH) - Shed under severe overload:               │
│  ├─ Job submissions                                            │
│  ├─ Workflow dispatch                                          │
│  └─ State sync requests                                        │
│                                                                 │
│  Priority 2 (NORMAL) - Shed under moderate overload:           │
│  ├─ Progress updates                                           │
│  ├─ Stats queries                                              │
│  └─ Reconnection requests                                      │
│                                                                 │
│  Priority 3 (LOW) - Shed first:                                │
│  ├─ Detailed stats                                             │
│  ├─ Debug/diagnostic requests                                  │
│  └─ Non-essential sync                                         │
│                                                                 │
│  Shedding Thresholds (based on overload state):                │
│  ├─ healthy: shed nothing                                      │
│  ├─ busy: shed Priority 3                                      │
│  ├─ stressed: shed Priority 2-3                                │
│  └─ overloaded: shed Priority 1-3 (only CRITICAL processed)   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation**:
```python
class RequestPriority(Enum):
    CRITICAL = 0
    HIGH = 1
    NORMAL = 2
    LOW = 3

class LoadShedder:
    """Determines whether to shed requests based on priority and load."""

    def __init__(self, overload_detector: HybridOverloadDetector):
        self._detector = overload_detector

        # Map overload state to minimum priority processed
        self._shed_thresholds: dict[str, int] = {
            "healthy": 4,    # Process all (nothing shed)
            "busy": 3,       # Shed LOW
            "stressed": 2,   # Shed NORMAL and LOW
            "overloaded": 1, # Only CRITICAL (shed HIGH, NORMAL, LOW)
        }

    def should_shed(self, priority: RequestPriority) -> bool:
        """Return True if request should be shed."""
        state = self._detector.get_state()
        min_priority = self._shed_thresholds.get(state, 4)
        return priority.value >= min_priority

    def classify_request(self, message_type: str) -> RequestPriority:
        """Classify request by message type."""
        critical_types = {"ping", "cancel_job", "final_result", "swim_*"}
        high_types = {"job_submit", "workflow_dispatch", "state_sync"}
        normal_types = {"progress_update", "stats_query", "register_callback"}

        if message_type in critical_types:
            return RequestPriority.CRITICAL
        elif message_type in high_types:
            return RequestPriority.HIGH
        elif message_type in normal_types:
            return RequestPriority.NORMAL
        else:
            return RequestPriority.LOW
```
