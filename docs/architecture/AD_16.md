---
ad_number: 16
name: Datacenter Health Classification
description: Classify datacenter health into four distinct states to enable intelligent routing
---

# AD-16: Datacenter Health Classification

**Decision**: Classify datacenter health into four distinct states to enable intelligent routing.

**Rationale**:
- BUSY ≠ UNHEALTHY (critical distinction)
- BUSY = transient, will clear when workflows complete
- DEGRADED = structural problem, reduced capacity but operational
- UNHEALTHY = severe problem, requires intervention
- Routing should actively seek healthier DCs before accepting degraded states

**States** (evaluated in order):

| State | Definition | Condition |
|-------|------------|-----------|
| UNHEALTHY | No managers responding OR no workers registered | `alive_managers == 0` OR `worker_count == 0` |
| DEGRADED | Majority of workers unhealthy OR majority of managers unhealthy | `healthy_workers < worker_count // 2 + 1` OR `alive_managers < total_managers // 2 + 1` |
| BUSY | Not degraded AND no available capacity | NOT degraded AND `available_cores == 0` |
| HEALTHY | Not degraded AND capacity available | NOT degraded AND `available_cores > 0` |

**Key Metrics from ManagerHeartbeat**:
- `worker_count`: Total registered workers
- `healthy_worker_count`: Workers responding to SWIM probes
- `available_cores`: Available cores from healthy workers only
- `total_cores`: Total cores across all registered workers

**Implementation**:
```python
class DatacenterHealth(Enum):
    HEALTHY = "healthy"      # Capacity available, all systems operational
    BUSY = "busy"            # No capacity but structurally healthy (transient)
    DEGRADED = "degraded"    # Majority of workers/managers unhealthy
    UNHEALTHY = "unhealthy"  # No managers OR no workers

def _classify_datacenter_health(self, dc_id: str) -> DatacenterStatus:
    # 1. Check manager liveness via SWIM
    # 2. If alive_managers == 0 → UNHEALTHY
    # 3. If no workers registered → UNHEALTHY
    # 4. Check majority health:
    #    - healthy_workers < worker_quorum → DEGRADED
    #    - alive_managers < manager_quorum → DEGRADED
    # 5. If not degraded and available_cores == 0 → BUSY
    # 6. If not degraded and available_cores > 0 → HEALTHY
```
