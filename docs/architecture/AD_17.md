---
ad_number: 17
name: Smart Dispatch with Fallback Chain
description: Implement cascading fallback for job dispatch across datacenters
---

# AD-17: Smart Dispatch with Fallback Chain

**Decision**: Implement cascading fallback for job dispatch across datacenters.

**Rationale**:
- Single DC failure shouldn't fail entire job
- Automatic recovery without client involvement
- Actively seek healthier DCs before accepting degraded states
- Preserve user's datacenter preferences while enabling fallback

**Routing Rules** (in order of preference):

| Current DC State | Action |
|------------------|--------|
| HEALTHY | Enqueue job (preferred) |
| BUSY | Fallback to HEALTHY DC if available, else queue |
| DEGRADED | Fallback to HEALTHY or BUSY DC if available, else queue with warning |
| UNHEALTHY | Fallback to any non-UNHEALTHY DC, else **fail job with error** |

**Selection Priority**: HEALTHY > BUSY > DEGRADED (UNHEALTHY excluded)

**Flow**:
1. Classify all DCs by health
2. Bucket DCs: HEALTHY (sorted by capacity), BUSY, DEGRADED
3. Determine `worst_health` we must accept
4. Select primary DCs from best available bucket
5. Build fallback list from remaining usable DCs
6. Dispatch with appropriate logging:
   - If `worst_health == "unhealthy"` → **fail job immediately**
   - If `worst_health == "degraded"` → log warning, then queue
   - If `worst_health == "busy"` → log info, then queue
   - If `worst_health == "healthy"` → queue normally

**Implementation**:
```python
def _select_datacenters_with_fallback(
    self,
    count: int,
    preferred: list[str] | None = None,
) -> tuple[list[str], list[str], str]:  # (primary_dcs, fallback_dcs, worst_health)
    # worst_health: "healthy" | "busy" | "degraded" | "unhealthy"

async def _dispatch_job_to_datacenters(
    self,
    submission: JobSubmission,
    target_dcs: list[str],
) -> None:
    primary_dcs, fallback_dcs, worst_health = self._select_datacenters_with_fallback(...)

    if worst_health == "unhealthy":
        # Fail job - no usable DCs
        job.status = JobStatus.FAILED
        return

    if worst_health == "degraded":
        log_warning("Routing to DEGRADED DCs")
    elif worst_health == "busy":
        log_info("Routing to BUSY DCs")

    # Dispatch with fallback support
    await self._dispatch_job_with_fallback(submission, primary_dcs, fallback_dcs)
```
